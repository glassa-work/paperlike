<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paperlike</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* ============================================================
       PAPERLIKE ‚Äî Obsidian + Excalidraw inspired UI
       Hand-drawn Caveat font everywhere for paper-like feel
       ============================================================ */
    :root {
      --font: 'Caveat', cursive;
      --bg: #faf8f5;
      --surface: #ffffff;
      --sidebar-bg: #1e1e2e;
      --sidebar-text: #cdd6f4;
      --sidebar-active: #89b4fa;
      --sidebar-hover: #313244;
      --border: #e8e4de;
      --text: #2c2c2c;
      --muted: #888580;
      --accent: #5b8af5;
      --accent-soft: rgba(91,138,245,0.12);
      --green: #40a06c;
      --green-soft: rgba(64,160,108,0.12);
      --red: #e64553;
      --red-soft: rgba(230,69,83,0.12);
      --orange: #df8e1d;
      --purple: #8839ef;
      --purple-soft: rgba(136,57,239,0.12);
      --canvas-dot: #ddd8d0;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 20px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 40px rgba(0,0,0,0.15);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font);
      font-size: 1.25rem;
      color: var(--text);
      background: var(--bg);
      display: flex;
    }

    /* ===== SIDEBAR (Obsidian-style) ===== */
    .sidebar {
      width: 220px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      user-select: none;
      z-index: 10;
    }

    .sidebar-brand {
      padding: 20px 18px 16px;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: #fff;
      border-bottom: 1px solid #313244;
    }

    .sidebar-nav {
      flex: 1;
      padding: 8px 8px;
      overflow-y: auto;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1.1rem;
      color: var(--sidebar-text);
      transition: background 0.15s;
    }

    .sidebar-item:hover { background: var(--sidebar-hover); }

    .sidebar-item.active {
      background: rgba(137,180,250,0.12);
      color: var(--sidebar-active);
      font-weight: 600;
    }

    .sidebar-item .nav-icon {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .sidebar-divider {
      height: 1px;
      background: #313244;
      margin: 8px 14px;
    }

    .sidebar-section-label {
      font-size: 0.85rem;
      color: #6c7086;
      padding: 8px 14px 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    /* ===== MAIN CONTENT ===== */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    .page-view {
      display: none;
      max-width: 860px;
      margin: 0 auto;
      padding: 40px 48px 80px;
      min-height: 100%;
    }

    .page-view.active {
      display: block;
    }

    /* ===== FLOATING TOOLBAR ===== */
    .float-toolbar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 40px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 3px;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
    }

    .float-toolbar.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .float-toolbar button {
      font-family: var(--font);
      font-size: 1.15rem;
      padding: 8px 14px;
      border: none;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      border-radius: 20px;
      transition: background 0.12s;
      white-space: nowrap;
    }

    .float-toolbar button:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .float-toolbar button.active-tool {
      background: var(--accent);
      color: #fff;
    }

    .float-toolbar button.danger-tool:hover {
      background: var(--red-soft);
      color: var(--red);
    }

    .float-toolbar .separator {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 4px;
    }

    /* ===== EDITOR PAGE ===== */
    .editor-title {
      font-size: 2.8rem;
      font-weight: 700;
      color: var(--text);
      border: none;
      outline: none;
      width: 100%;
      margin-bottom: 8px;
      line-height: 1.15;
    }

    .editor-meta {
      font-size: 1rem;
      color: var(--muted);
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .meta-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      display: inline-block;
    }

    .block-editor {
      min-height: 200px;
    }

    .block {
      padding: 6px 0;
      border-radius: var(--radius-sm);
      cursor: text;
      position: relative;
      transition: background 0.12s;
    }

    .block:hover {
      background: rgba(0,0,0,0.018);
    }

    .block.selected {
      background: var(--accent-soft);
    }

    .block .handle {
      position: absolute;
      left: -32px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      opacity: 0;
      cursor: grab;
      font-size: 1.1rem;
      transition: opacity 0.15s;
    }

    .block:hover .handle { opacity: 0.5; }
    .block:hover .handle:hover { opacity: 1; }

    .block p {
      font-size: 1.35rem;
      line-height: 1.7;
      margin: 0;
    }

    .block h1 {
      font-size: 2.4rem;
      font-weight: 700;
      line-height: 1.2;
      margin: 20px 0 8px;
    }

    .block h2 {
      font-size: 1.9rem;
      font-weight: 600;
      line-height: 1.3;
      margin: 16px 0 6px;
    }

    .block h3 {
      font-size: 1.6rem;
      font-weight: 600;
      line-height: 1.35;
      margin: 12px 0 4px;
    }

    .block ul, .block ol {
      padding-left: 24px;
      font-size: 1.3rem;
      line-height: 1.8;
    }

    .block li { margin: 2px 0; }

    .block .drawing-embed {
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 24px;
      text-align: center;
      color: var(--purple);
      font-size: 1.2rem;
      margin: 12px 0;
    }

    .block .spacer-line {
      height: 1px;
      background: var(--border);
      margin: 20px 0;
    }

    .block .section-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 14px;
      background: var(--purple-soft);
      color: var(--purple);
      border-radius: 20px;
      font-size: 1.1rem;
    }

    .add-block-line {
      padding: 12px 0;
      text-align: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .block-editor:hover .add-block-line { opacity: 1; }

    .add-block-line button {
      font-family: var(--font);
      font-size: 1.1rem;
      background: none;
      border: 1px dashed var(--border);
      color: var(--muted);
      padding: 6px 18px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .add-block-line button:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }

    /* ===== DRAWING PAGE ===== */
    .drawing-canvas {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      position: relative;
      height: 500px;
      overflow: hidden;
      cursor: crosshair;
      background-image: radial-gradient(circle, var(--canvas-dot) 1px, transparent 1px);
      background-size: 24px 24px;
    }

    .canvas-element {
      position: absolute;
      border: 2px solid;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      cursor: move;
      user-select: none;
      transition: filter 0.15s;
    }

    .canvas-element:hover {
      filter: brightness(1.05);
    }

    .canvas-element.selected {
      box-shadow: 0 0 0 3px var(--accent), 0 0 0 5px rgba(91,138,245,0.2);
    }

    .drawing-status {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      font-size: 1.05rem;
      color: var(--muted);
    }

    /* ===== COMMENTS PAGE ===== */
    .comments-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .device-panel {
      flex: 1;
      min-width: 0;
    }

    .device-label {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sync-badge {
      font-size: 0.9rem;
      padding: 2px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .sync-badge.synced { background: var(--green-soft); color: var(--green); }
    .sync-badge.offline { background: var(--red-soft); color: var(--red); }
    .sync-badge.pending { background: rgba(223,142,29,0.12); color: var(--orange); }

    .comment-thread {
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }

    .comment-thread:last-child { border-bottom: none; }

    .comment-author-name {
      font-weight: 600;
      color: var(--accent);
      font-size: 1.15rem;
    }

    .comment-on {
      font-size: 0.95rem;
      color: var(--muted);
      margin-left: 8px;
    }

    .comment-body {
      margin-top: 4px;
      font-size: 1.2rem;
      line-height: 1.5;
    }

    .two-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }

    .panel-divider {
      width: 1px;
      background: var(--border);
    }

    @media (max-width: 700px) {
      .two-panel { grid-template-columns: 1fr; }
    }

    /* ===== COLUMNS PAGE ===== */
    .columns-layout {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }

    .col-lane {
      flex: 1;
      background: rgba(0,0,0,0.02);
      border-radius: var(--radius-sm);
      padding: 14px;
      min-height: 80px;
    }

    .col-lane-label {
      font-size: 0.9rem;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 10px;
    }

    .col-lane-block {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 14px;
      margin-bottom: 8px;
      font-size: 1.15rem;
    }

    /* ===== EXPORT PAGE ===== */
    .export-terminal {
      background: #1e1e2e;
      color: #cdd6f4;
      border-radius: var(--radius);
      padding: 20px 24px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.6;
    }

    /* ===== EMPTY STATES ===== */
    .empty {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      font-size: 1.2rem;
    }

    .empty-dashed {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      font-size: 1.2rem;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
    }

    /* ===== PAGE TITLES ===== */
    .page-title {
      font-size: 2.6rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .page-subtitle {
      font-size: 1.15rem;
      color: var(--muted);
      margin-bottom: 32px;
      line-height: 1.5;
    }

    /* ===== LOG ===== */
    .log-panel {
      margin-top: 20px;
      background: rgba(0,0,0,0.02);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      max-height: 140px;
      overflow-y: auto;
      font-size: 1rem;
    }

    .log-line {
      padding: 3px 0;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      display: flex;
      gap: 8px;
    }

    .log-line:last-child { border-bottom: none; }
    .log-ts { color: var(--muted); font-size: 0.9rem; flex-shrink: 0; }
    .log-msg { color: var(--accent); font-weight: 500; }
  </style>
</head>
<body>

<!-- ===== SIDEBAR ===== -->
<div class="sidebar">
  <div class="sidebar-brand">üìù Paperlike</div>
  <nav class="sidebar-nav">
    <div class="sidebar-section-label">Document</div>
    <div class="sidebar-item active" data-page="editor" onclick="showPage('editor')">
      <span class="nav-icon">üìÑ</span> Editor
    </div>
    <div class="sidebar-item" data-page="drawing" onclick="showPage('drawing')">
      <span class="nav-icon">üé®</span> Drawing
    </div>
    <div class="sidebar-item" data-page="comments" onclick="showPage('comments')">
      <span class="nav-icon">üí¨</span> Comments
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section-label">Layout</div>
    <div class="sidebar-item" data-page="columns" onclick="showPage('columns')">
      <span class="nav-icon">üìä</span> Columns
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section-label">File</div>
    <div class="sidebar-item" data-page="export" onclick="showPage('export')">
      <span class="nav-icon">üì¶</span> Export
    </div>
  </nav>
</div>

<!-- ===== MAIN ===== -->
<div class="main-area">
  <div class="content-scroll">

    <!-- EDITOR PAGE -->
    <div class="page-view active" id="page-editor">
      <div class="editor-title">Welcome to Paperlike</div>
      <div class="editor-meta">
        <span><span class="meta-dot"></span> Lease active</span>
        <span>Version <strong id="doc-version">0</strong></span>
        <span><strong id="block-count">0</strong> blocks</span>
      </div>
      <div class="block-editor" id="block-editor"></div>
      <div class="add-block-line">
        <button onclick="addParagraph()">+ add block</button>
      </div>
      <div class="log-panel" id="body-log">
        <div class="log-line"><span class="log-ts">ready</span><span class="log-msg">editor initialized</span></div>
      </div>
    </div>

    <!-- DRAWING PAGE -->
    <div class="page-view" id="page-drawing">
      <div class="page-title">Drawing Canvas</div>
      <div class="page-subtitle">Excalidraw-compatible ‚Äî add shapes, undo/redo, persistent history</div>
      <div class="drawing-canvas" id="canvas-area" onclick="canvasClick(event)"></div>
      <div class="drawing-status">
        <span id="history-info">cursor: -1 / 0 actions</span>
        <span>¬∑</span>
        <span id="elem-count">0 elements</span>
      </div>
      <div class="log-panel" id="draw-log">
        <div class="log-line"><span class="log-ts">ready</span><span class="log-msg">canvas initialized</span></div>
      </div>
    </div>

    <!-- COMMENTS PAGE -->
    <div class="page-view" id="page-comments">
      <div class="page-title">Comments</div>
      <div class="page-subtitle">CRDT-powered ‚Äî offline edits from multiple devices merge automatically</div>
      <div class="two-panel">
        <div class="device-panel">
          <div class="device-label">üì± Device A <span class="sync-badge synced" id="sync-a">synced</span></div>
          <div id="comments-a"><div class="empty">no comments yet</div></div>
        </div>
        <div class="device-panel">
          <div class="device-label">üíª Device B <span class="sync-badge synced" id="sync-b">synced</span></div>
          <div id="comments-b"><div class="empty">no comments yet</div></div>
        </div>
      </div>
    </div>

    <!-- COLUMNS PAGE -->
    <div class="page-view" id="page-columns">
      <div class="page-title">Column Sections</div>
      <div class="page-subtitle">Recursive lane-based layouts ‚Äî sections nest inside sections</div>
      <div id="columns-area">
        <div class="empty-dashed">add a column layout below</div>
      </div>
    </div>

    <!-- EXPORT PAGE -->
    <div class="page-view" id="page-export">
      <div class="page-title">Export / Import</div>
      <div class="page-subtitle">.paperlike bundle ‚Äî body.json, drawings, comments, manifest</div>
      <div class="export-terminal" id="export-preview">click "export" in the toolbar to see the serialized bundle</div>
    </div>

  </div>
</div>

<!-- ===== FLOATING TOOLBARS ===== -->
<div class="float-toolbar visible" id="toolbar-editor">
  <button onclick="addParagraph()" title="Paragraph">¬∂</button>
  <button onclick="addHeading()" title="Heading">H</button>
  <button onclick="addList()" title="List">‚ò∞</button>
  <button onclick="addDrawingRef()" title="Drawing">üñº</button>
  <button onclick="addSpacer()" title="Spacer">‚Äî</button>
  <div class="separator"></div>
  <button onclick="updateSelected()" title="Edit">‚úé</button>
  <button onclick="moveSelectedUp()" title="Move up">‚Üë</button>
  <button onclick="moveSelectedDown()" title="Move down">‚Üì</button>
  <button class="danger-tool" onclick="deleteSelected()" title="Delete">‚úï</button>
</div>

<div class="float-toolbar" id="toolbar-drawing">
  <button onclick="drawUndo()" id="btn-undo" title="Undo">‚Ü©</button>
  <button onclick="drawRedo()" id="btn-redo" title="Redo">‚Ü™</button>
  <div class="separator"></div>
  <button onclick="addRect()" title="Rectangle">‚ñ≠</button>
  <button onclick="addCircle()" title="Ellipse">‚óØ</button>
  <button onclick="addLine()" title="Line">‚ï±</button>
  <button onclick="randomizeColors()" title="Recolor">üé®</button>
  <div class="separator"></div>
  <button class="danger-tool" onclick="deleteDrawingSelected()" title="Delete">‚úï</button>
</div>

<div class="float-toolbar" id="toolbar-comments">
  <button onclick="addCommentA()" title="Alice comments">üë© Alice</button>
  <button onclick="addCommentB()" title="Bob comments">üë® Bob</button>
  <div class="separator"></div>
  <button onclick="syncComments()" title="Sync">üîÑ sync</button>
  <button onclick="goOffline()" title="Go offline">üì¥</button>
  <button onclick="goOnline()" title="Go online">üì∂</button>
</div>

<div class="float-toolbar" id="toolbar-columns">
  <button onclick="addTwoColumns()">2 columns</button>
  <button onclick="addThreeColumns()">3 columns</button>
  <button onclick="addNestedSection()">nested</button>
</div>

<div class="float-toolbar" id="toolbar-export">
  <button onclick="exportBundle()">üì§ export</button>
  <button onclick="reimportBundle()">üì• re-import</button>
</div>

<script>
// =========================================================================
// PAPERLIKE DEMO ‚Äî Obsidian + Excalidraw inspired
// =========================================================================

// --- Navigation ---
let currentPage = 'editor';

function showPage(name) {
  currentPage = name;
  document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('.sidebar-item').forEach(s => {
    s.classList.toggle('active', s.dataset.page === name);
  });
  // Show correct floating toolbar
  document.querySelectorAll('.float-toolbar').forEach(t => t.classList.remove('visible'));
  const tb = document.getElementById('toolbar-' + name);
  if (tb) tb.classList.add('visible');
}

// --- Branded ID helpers ---
let idCounter = 0;
const makeId = (prefix) => `${prefix}-${++idCounter}`;

// --- State ---
let blocks = [];
let selectedBlockId = null;
let docVersion = 0;

let drawingElements = [];
let drawingAppState = { viewBackgroundColor: '#ffffff' };
let drawingFiles = {};
let drawingActions = [];
let historyState = { undoCursor: -1, actionCount: 0 };
let selectedElementId = null;

let commentsOnline = true;
let pendingA = [];
let pendingB = [];
let commentsA = [];
let commentsB = [];
let commentCounterA = 0;
let commentCounterB = 0;

const sampleTexts = [
  "This paragraph needs more detail",
  "Great point, well articulated",
  "Consider adding an example here",
  "The drawing should include labels",
  "This section is ready for review",
  "Can we simplify this wording?",
  "Nice layout structure!",
  "Let's add more context",
];

const sampleParas = [
  "Paperlike enables collaborative document editing with real-time sync.",
  "The block-based architecture supports paragraphs, headings, lists, and embedded drawings.",
  "Each document maintains a versioned history of all changes.",
  "CRDT-based comments allow offline editing with automatic merge on reconnection.",
  "Sections support recursive column layouts for complex document structures.",
];

const sampleHeadings = [
  "Introduction",
  "Getting Started",
  "Architecture Overview",
  "API Reference",
  "Conclusion",
];

// ===== BLOCK EDITOR =====

function renderBlocks() {
  const el = document.getElementById('block-editor');
  if (blocks.length === 0) {
    el.innerHTML = '<div class="empty">start typing ‚Äî or use the toolbar to add blocks</div>';
  } else {
    el.innerHTML = blocks.map(b => {
      const sel = b.id === selectedBlockId ? ' selected' : '';
      let inner = '';
      switch (b.type) {
        case 'paragraph':
          inner = `<p>${b.text}</p>`;
          break;
        case 'heading':
          inner = `<h${b.level}>${b.text}</h${b.level}>`;
          break;
        case 'list':
          const tag = b.ordered ? 'ol' : 'ul';
          inner = `<${tag}>${b.items.map(i => `<li>${i}</li>`).join('')}</${tag}>`;
          break;
        case 'drawing_ref':
          inner = `<div class="drawing-embed">üñº embedded drawing: ${b.drawingId}</div>`;
          break;
        case 'spacer':
          inner = `<div class="spacer-line"></div>`;
          break;
        case 'section':
          inner = `<span class="section-badge">‚äû section ¬∑ ${b.layout.lanes.length} lanes</span>`;
          break;
      }
      return `<div class="block${sel}" onclick="selectBlock('${b.id}')">
        <span class="handle">‚†ø</span>${inner}
      </div>`;
    }).join('');
  }
  document.getElementById('block-count').textContent = blocks.length;
  document.getElementById('doc-version').textContent = docVersion;
}

function logBody(msg) {
  const el = document.getElementById('body-log');
  const time = new Date().toLocaleTimeString();
  el.innerHTML += `<div class="log-line"><span class="log-ts">${time}</span><span class="log-msg">${msg}</span></div>`;
  el.scrollTop = el.scrollHeight;
}

function selectBlock(id) {
  selectedBlockId = selectedBlockId === id ? null : id;
  renderBlocks();
}

function insertBlockAfter(block) {
  if (selectedBlockId) {
    const idx = blocks.findIndex(b => b.id === selectedBlockId);
    if (idx !== -1) {
      blocks = [...blocks.slice(0, idx + 1), block, ...blocks.slice(idx + 1)];
    } else {
      blocks = [...blocks, block];
    }
  } else {
    blocks = [...blocks, block];
  }
  docVersion++;
  selectedBlockId = block.id;
  renderBlocks();
}

function addParagraph() {
  const text = sampleParas[Math.floor(Math.random() * sampleParas.length)];
  const block = { id: makeId('p'), type: 'paragraph', text };
  insertBlockAfter(block);
  logBody(`insert paragraph`);
}

function addHeading() {
  const text = sampleHeadings[Math.floor(Math.random() * sampleHeadings.length)];
  const level = Math.ceil(Math.random() * 3);
  const block = { id: makeId('h'), type: 'heading', text, level };
  insertBlockAfter(block);
  logBody(`insert h${level}: "${text}"`);
}

function addList() {
  const block = {
    id: makeId('li'),
    type: 'list',
    items: ['First item', 'Second item', 'Third item'],
    ordered: Math.random() > 0.5
  };
  insertBlockAfter(block);
  logBody(`insert list`);
}

function addDrawingRef() {
  const block = { id: makeId('dr'), type: 'drawing_ref', drawingId: 'drawing-e2e' };
  insertBlockAfter(block);
  logBody(`insert drawing ref`);
}

function addSpacer() {
  const block = { id: makeId('sp'), type: 'spacer' };
  insertBlockAfter(block);
  logBody(`insert spacer`);
}

function updateSelected() {
  if (!selectedBlockId) return;
  const block = blocks.find(b => b.id === selectedBlockId);
  if (!block) return;
  if (block.type === 'paragraph' || block.type === 'heading') {
    const newText = prompt('Edit text:', block.text);
    if (newText !== null) {
      blocks = blocks.map(b => b.id === selectedBlockId ? { ...b, text: newText } : b);
      docVersion++;
      renderBlocks();
      logBody(`update: "${newText.slice(0, 30)}‚Ä¶"`);
    }
  }
}

function deleteSelected() {
  if (!selectedBlockId) return;
  const id = selectedBlockId;
  blocks = blocks.filter(b => b.id !== id);
  selectedBlockId = null;
  docVersion++;
  renderBlocks();
  logBody(`delete ${id}`);
}

function moveSelectedUp() {
  if (!selectedBlockId) return;
  const idx = blocks.findIndex(b => b.id === selectedBlockId);
  if (idx <= 0) return;
  const nb = [...blocks];
  [nb[idx - 1], nb[idx]] = [nb[idx], nb[idx - 1]];
  blocks = nb;
  docVersion++;
  renderBlocks();
  logBody(`move up`);
}

function moveSelectedDown() {
  if (!selectedBlockId) return;
  const idx = blocks.findIndex(b => b.id === selectedBlockId);
  if (idx === -1 || idx >= blocks.length - 1) return;
  const nb = [...blocks];
  [nb[idx], nb[idx + 1]] = [nb[idx + 1], nb[idx]];
  blocks = nb;
  docVersion++;
  renderBlocks();
  logBody(`move down`);
}

// ===== DRAWING CANVAS =====

const colors = ['#5b8af5', '#e64553', '#40a06c', '#df8e1d', '#8839ef', '#ea76cb', '#179299', '#fe640b'];

function renderCanvas() {
  const canvas = document.getElementById('canvas-area');
  canvas.innerHTML = drawingElements.map(el => {
    const sel = el.id === selectedElementId ? ' selected' : '';
    const color = el.strokeColor || colors[0];
    const bg = el.backgroundColor || 'transparent';
    let borderRadius = '4px';
    if (el.type === 'ellipse') borderRadius = '50%';
    if (el.type === 'line') {
      return `<div class="canvas-element${sel}" data-id="${el.id}"
        onclick="event.stopPropagation(); selectElement('${el.id}')"
        style="left:${el.x}px;top:${el.y}px;width:${el.width}px;height:2px;
        background:${color};border:none;border-radius:0;
        transform:rotate(${el.angle || 0}deg)"></div>`;
    }
    return `<div class="canvas-element${sel}" data-id="${el.id}"
      onclick="event.stopPropagation(); selectElement('${el.id}')"
      style="left:${el.x}px;top:${el.y}px;width:${el.width}px;height:${el.height}px;
      border-color:${color};background:${bg};border-radius:${borderRadius}">
      <span style="color:${color};font-family:var(--font)">${el.type === 'rectangle' ? '‚ñ≠' : '‚óØ'}</span>
    </div>`;
  }).join('');

  document.getElementById('history-info').textContent =
    `cursor: ${historyState.undoCursor} / ${historyState.actionCount} actions`;
  document.getElementById('elem-count').textContent =
    `${drawingElements.length} elements`;
  document.getElementById('btn-undo').disabled = historyState.undoCursor < 0;
  document.getElementById('btn-redo').disabled = historyState.undoCursor >= historyState.actionCount - 1;
}

function logDraw(msg) {
  const el = document.getElementById('draw-log');
  const time = new Date().toLocaleTimeString();
  el.innerHTML += `<div class="log-line"><span class="log-ts">${time}</span><span class="log-msg">${msg}</span></div>`;
  el.scrollTop = el.scrollHeight;
}

function selectElement(id) {
  selectedElementId = selectedElementId === id ? null : id;
  renderCanvas();
}

function canvasClick() {
  selectedElementId = null;
  renderCanvas();
}

function addShapeAt(type) {
  const canvas = document.getElementById('canvas-area');
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  const size = type === 'line'
    ? { width: 80 + Math.random() * 120, height: 0 }
    : { width: 60 + Math.random() * 100, height: 40 + Math.random() * 80 };
  const x = 30 + Math.random() * (w - size.width - 60);
  const y = 30 + Math.random() * (h - (size.height || 20) - 60);
  const color = colors[Math.floor(Math.random() * colors.length)];
  const bg = Math.random() > 0.4 ? color + '18' : 'transparent';

  const el = {
    id: makeId('el'),
    type,
    x: Math.round(x), y: Math.round(y),
    ...size,
    strokeColor: color,
    backgroundColor: bg,
    angle: type === 'line' ? Math.round(Math.random() * 40 - 20) : 0,
  };

  const action = {
    drawingId: 'drawing-e2e',
    historyGroupId: makeId('hg'),
    forward: [{ type: 'add_element', element: el }],
    inverse: [{ type: 'delete_element', elementId: el.id }],
    timestamp: Date.now(),
  };

  drawingActions = drawingActions.slice(0, historyState.undoCursor + 1);
  drawingActions.push(action);
  drawingElements.push(el);
  historyState = { undoCursor: drawingActions.length - 1, actionCount: drawingActions.length };
  selectedElementId = el.id;
  renderCanvas();
  logDraw(`add ${type} at (${el.x}, ${el.y})`);
}

function addRect() { addShapeAt('rectangle'); }
function addCircle() { addShapeAt('ellipse'); }
function addLine() { addShapeAt('line'); }

function randomizeColors() {
  if (drawingElements.length === 0) return;
  const fwd = [], inv = [];
  drawingElements = drawingElements.map(el => {
    const nc = colors[Math.floor(Math.random() * colors.length)];
    const nb = Math.random() > 0.4 ? nc + '18' : 'transparent';
    inv.push({ type: 'update_element', elementId: el.id, patch: { strokeColor: el.strokeColor, backgroundColor: el.backgroundColor } });
    fwd.push({ type: 'update_element', elementId: el.id, patch: { strokeColor: nc, backgroundColor: nb } });
    return { ...el, strokeColor: nc, backgroundColor: nb };
  });
  const action = { drawingId: 'drawing-e2e', historyGroupId: makeId('hg'), forward: fwd, inverse: inv, timestamp: Date.now() };
  drawingActions = drawingActions.slice(0, historyState.undoCursor + 1);
  drawingActions.push(action);
  historyState = { undoCursor: drawingActions.length - 1, actionCount: drawingActions.length };
  renderCanvas();
  logDraw(`recolored ${drawingElements.length} elements`);
}

function deleteDrawingSelected() {
  if (!selectedElementId) return;
  const el = drawingElements.find(e => e.id === selectedElementId);
  if (!el) return;
  const action = {
    drawingId: 'drawing-e2e', historyGroupId: makeId('hg'),
    forward: [{ type: 'delete_element', elementId: el.id }],
    inverse: [{ type: 'add_element', element: el }],
    timestamp: Date.now(),
  };
  drawingActions = drawingActions.slice(0, historyState.undoCursor + 1);
  drawingActions.push(action);
  drawingElements = drawingElements.filter(e => e.id !== selectedElementId);
  historyState = { undoCursor: drawingActions.length - 1, actionCount: drawingActions.length };
  selectedElementId = null;
  renderCanvas();
  logDraw(`deleted element`);
}

function applyPatches(patches) {
  patches.forEach(patch => {
    switch (patch.type) {
      case 'add_element': drawingElements.push(patch.element); break;
      case 'delete_element': drawingElements = drawingElements.filter(e => e.id !== patch.elementId); break;
      case 'update_element': drawingElements = drawingElements.map(e => e.id === patch.elementId ? { ...e, ...patch.patch } : e); break;
    }
  });
}

function drawUndo() {
  if (historyState.undoCursor < 0) return;
  const a = drawingActions[historyState.undoCursor];
  if (!a) return;
  applyPatches(a.inverse);
  historyState = { ...historyState, undoCursor: historyState.undoCursor - 1 };
  renderCanvas();
  logDraw(`undo ‚Üí ${historyState.undoCursor}`);
}

function drawRedo() {
  if (historyState.undoCursor >= historyState.actionCount - 1) return;
  const a = drawingActions[historyState.undoCursor + 1];
  if (!a) return;
  applyPatches(a.forward);
  historyState = { ...historyState, undoCursor: historyState.undoCursor + 1 };
  renderCanvas();
  logDraw(`redo ‚Üí ${historyState.undoCursor}`);
}

// ===== COMMENTS =====

function renderComments() {
  renderCommentList('comments-a', commentsA);
  renderCommentList('comments-b', commentsB);
}

function renderCommentList(id, comments) {
  const el = document.getElementById(id);
  if (comments.length === 0) {
    el.innerHTML = '<div class="empty">no comments yet</div>';
    return;
  }
  el.innerHTML = comments.map(c => `
    <div class="comment-thread">
      <span class="comment-author-name">${c.author}</span>
      <span class="comment-on">on ${c.anchor}</span>
      <div class="comment-body">${c.text}</div>
    </div>
  `).join('');
}

function addCommentA() {
  const text = sampleTexts[commentCounterA++ % sampleTexts.length];
  const c = { id: makeId('c'), author: 'üë© Alice', anchor: blocks.length > 0 ? blocks[Math.floor(Math.random() * blocks.length)].id : 'doc', text, createdAt: Date.now() };
  commentsA.push(c);
  if (commentsOnline) { commentsB.push(c); }
  else { pendingA.push(c); document.getElementById('sync-a').className = 'sync-badge pending'; document.getElementById('sync-a').textContent = 'pending'; }
  renderComments();
}

function addCommentB() {
  const text = sampleTexts[commentCounterB++ % sampleTexts.length];
  const c = { id: makeId('c'), author: 'üë® Bob', anchor: blocks.length > 0 ? blocks[Math.floor(Math.random() * blocks.length)].id : 'doc', text, createdAt: Date.now() };
  commentsB.push(c);
  if (commentsOnline) { commentsA.push(c); }
  else { pendingB.push(c); document.getElementById('sync-b').className = 'sync-badge pending'; document.getElementById('sync-b').textContent = 'pending'; }
  renderComments();
}

function syncComments() {
  pendingA.forEach(c => { if (!commentsB.find(x => x.id === c.id)) commentsB.push(c); });
  pendingB.forEach(c => { if (!commentsA.find(x => x.id === c.id)) commentsA.push(c); });
  pendingA = []; pendingB = [];
  document.getElementById('sync-a').className = 'sync-badge synced'; document.getElementById('sync-a').textContent = 'synced';
  document.getElementById('sync-b').className = 'sync-badge synced'; document.getElementById('sync-b').textContent = 'synced';
  commentsOnline = true;
  renderComments();
}

function goOffline() {
  commentsOnline = false;
  document.getElementById('sync-a').className = 'sync-badge offline'; document.getElementById('sync-a').textContent = 'offline';
  document.getElementById('sync-b').className = 'sync-badge offline'; document.getElementById('sync-b').textContent = 'offline';
}

function goOnline() { syncComments(); }

// ===== COLUMNS =====

let columnSections = [];

function renderColumns() {
  const el = document.getElementById('columns-area');
  if (columnSections.length === 0) {
    el.innerHTML = '<div class="empty-dashed">add a column layout below</div>';
    return;
  }
  el.innerHTML = columnSections.map(renderSection).join('');
}

function renderSection(sec) {
  return `<div class="columns-layout">
    ${sec.lanes.map(lane => `
      <div class="col-lane">
        <div class="col-lane-label">${lane.name}</div>
        ${lane.blocks.map(b => `<div class="col-lane-block">${b}</div>`).join('')}
        ${lane.nested ? renderSection(lane.nested) : ''}
      </div>
    `).join('')}
  </div>`;
}

function addTwoColumns() {
  columnSections.push({ id: makeId('s'), lanes: [
    { name: 'Lane A', blocks: ['Introduction text goes here', 'With supporting details'] },
    { name: 'Lane B', blocks: ['Sidebar content', 'Additional notes', 'Reference links'] },
  ]});
  renderColumns();
}

function addThreeColumns() {
  columnSections.push({ id: makeId('s'), lanes: [
    { name: 'Left', blocks: ['Navigation', 'Menu items'] },
    { name: 'Center', blocks: ['Main content area', 'Primary article text', 'With multiple paragraphs'] },
    { name: 'Right', blocks: ['Related articles', 'Tags & categories'] },
  ]});
  renderColumns();
}

function addNestedSection() {
  columnSections.push({ id: makeId('s'), lanes: [
    { name: 'Outer Left', blocks: ['Outer content'], nested: { id: makeId('s'), lanes: [
      { name: 'Inner A', blocks: ['Nested block 1'] },
      { name: 'Inner B', blocks: ['Nested block 2', 'More nesting'] },
    ]}},
    { name: 'Outer Right', blocks: ['Right column', 'Content here'] },
  ]});
  renderColumns();
}

// ===== EXPORT =====

function exportBundle() {
  const manifest = { version: '1.0', docId: 'doc-demo', createdAt: new Date().toISOString(), drawingIds: ['drawing-e2e'] };
  const bodySnapshot = { docId: 'doc-demo', version: docVersion, blocks };
  const drawingScene = { drawingId: 'drawing-e2e', elements: drawingElements, appState: drawingAppState, files: drawingFiles };

  const preview = `üì¶ .paperlike bundle
${'‚ïê'.repeat(50)}

üìã manifest.json
${JSON.stringify(manifest, null, 2)}

üìÑ body.json (${blocks.length} blocks, version ${docVersion})
${JSON.stringify(bodySnapshot, null, 2).slice(0, 500)}${blocks.length > 3 ? '\n  ...' : ''}

üé® drawings/drawing-e2e.scene.json (${drawingElements.length} elements)
${JSON.stringify(drawingScene, null, 2).slice(0, 400)}${drawingElements.length > 2 ? '\n  ...' : ''}

üìú drawings/drawing-e2e.history.jsonl (${drawingActions.length} actions)
${drawingActions.slice(0, 2).map(a => JSON.stringify(a)).join('\n')}${drawingActions.length > 2 ? '\n...' : ''}

‚è± history_state.json
${JSON.stringify(historyState, null, 2)}

üí¨ comments: ${commentsA.length} on device A`;

  document.getElementById('export-preview').textContent = preview;
}

function reimportBundle() {
  if (blocks.length === 0 && drawingElements.length === 0) {
    document.getElementById('export-preview').textContent = '‚ö†Ô∏è nothing to re-import ‚Äî add content first';
    return;
  }
  const checks = [
    ['body blocks', blocks.length, JSON.parse(JSON.stringify(blocks)).length],
    ['doc version', docVersion, JSON.parse(JSON.stringify(docVersion))],
    ['drawing elements', drawingElements.length, JSON.parse(JSON.stringify(drawingElements)).length],
    ['history actions', drawingActions.length, JSON.parse(JSON.stringify(drawingActions)).length],
    ['history cursor', historyState.undoCursor, JSON.parse(JSON.stringify(historyState)).undoCursor],
  ];
  let r = `üì• re-import verification\n${'‚ïê'.repeat(50)}\n\n`;
  let ok = true;
  checks.forEach(([label, exp, act]) => {
    const pass = exp === act;
    if (!pass) ok = false;
    r += `${pass ? '‚úÖ' : '‚ùå'} ${label}: ${act} ${pass ? '(match)' : `(expected ${exp})`}\n`;
  });
  r += `\n${ok ? 'üéâ all checks passed ‚Äî state continuity verified!' : '‚ö†Ô∏è some checks failed'}`;
  document.getElementById('export-preview').textContent = r;
}

// ===== INIT =====

function initializeDemo() {
  blocks = [
    { id: makeId('h'), type: 'heading', text: 'Welcome to Paperlike', level: 1 },
    { id: makeId('p'), type: 'paragraph', text: 'Paperlike enables collaborative document editing with real-time sync, CRDT-based comments, and Excalidraw-compatible drawings.' },
    { id: makeId('p'), type: 'paragraph', text: 'The block-based architecture supports paragraphs, headings, lists, and embedded drawings with persistent undo/redo.' },
    { id: makeId('li'), type: 'list', items: ['Block editor with 6 block types', 'Drawing canvas with undo/redo', 'CRDT comments for offline collaboration', 'Recursive column sections', 'Export/import .paperlike bundles'], ordered: false },
    { id: makeId('dr'), type: 'drawing_ref', drawingId: 'drawing-e2e' },
  ];
  docVersion = 5;

  addShapeAt('rectangle');
  addShapeAt('ellipse');
  addShapeAt('rectangle');
  addShapeAt('line');
  addShapeAt('ellipse');

  commentsA = [
    { id: makeId('c'), author: 'üë© Alice', anchor: blocks[0].id, text: 'Great title!', createdAt: Date.now() - 60000 },
    { id: makeId('c'), author: 'üë® Bob', anchor: blocks[1].id, text: 'Consider adding more detail about the sync protocol.', createdAt: Date.now() - 30000 },
  ];
  commentsB = [...commentsA];

  addTwoColumns();

  renderBlocks();
  renderCanvas();
  renderComments();
}

initializeDemo();
</script>

</body>
</html>
